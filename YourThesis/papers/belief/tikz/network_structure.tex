\documentclass{article}
\usepackage{graphicx}
\usepackage{cite}
\usepackage{tikz}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{bm}
\usetikzlibrary{patterns}
\usetikzlibrary{fit}
\usepackage{pgfplots}
\pgfrealjobname{figures}
\usepackage{rotating}
\usepackage{amssymb}
\usepackage[english]{babel}
\usepackage{import}
\subimport{layers/}{init}
\usetikzlibrary{positioning}
\usetikzlibrary{3d} %for including external image 
\pgfplotsset{compat=1.16}

\begin{document}


	\def\InputColor{rgb:yellow,5;red,5;white,5}
	\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
	\def\ConvReluColor{rgb:yellow,5;red,5;white,5}
	\def\PoolColor{rgb:red,1;black,0.3}
	\def\UnpoolColor{rgb:blue,2;green,1;black,0.3}
	\def\FcColor{rgb:blue,5;red,2.5;white,5}
	\def\FcReluColor{rgb:blue,5;red,5;white,4}
	\def\SoftmaxColor{rgb:magenta,5;black,7}   

	

	\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width=0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

	\newcommand{\basenet}[1]{
	\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
	\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]
	
	% \def\BeliefSize{Belief}
	\def\BeliefDepth{#1}
	
	\pic[shift={(0,0,0)}] at (0,0,0) 
		{Box={
			name=input_ego,
			caption=Ego \\ input,
			xlabel={{ , }},
			ylabel=4,
			zlabel=\BeliefSize,
			fill=\InputColor,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\pic[shift={(2,0,0)}] at (input_ego-east) 
		{Box={
			name=fc_ego,
			caption= FC,
			xlabel={{32, }},
			zlabel=\BeliefSize,
			fill=\FcColor,
			height=8,
			width=4,
			depth=\BeliefDepth
			}
		};

	\draw [connection]  (input_ego-east)    -- node {\midarrow} (fc_ego-west);
	% \draw [connection]  (fc_ego-east)    -- node {\midarrow} (flat_ego-west);
	
	\pic[shift={(0,-3.6,0)}] at (input_ego-south) 
		{Box={
			name=input_target0,
			caption= ,
			xlabel={{ , }},
			ylabel=3,
			zlabel= ,
			fill=\InputColor,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	\pic[shift={(-0.1,-0.4,0)}] at (input_target0-south) 
		{Box={
			name=input_target1,
			caption= ,
			xlabel={{ , }},
			ylabel=3,
			zlabel= ,
			fill=\InputColor,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};

	\pic[shift={(-0.1,-0.4,0)}] at (input_target1-south) 
		{Box={
			name=input_target2,
			caption= ,
			xlabel={{ , }},
			ylabel=3,
			zlabel= ,
			fill=\InputColor,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};

	\pic[shift={(-0.1,-0.4,0)}] at (input_target2-south) 
		{Box={
			name=input_target3,
			caption= Target\\input,
			xlabel={{ , }},
			ylabel=3,
			zlabel=\BeliefSize,
			fill=\InputColor,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\pic[shift={(1.9,-0,0)}] at (input_target1-east) 
		{Box={
			name=conv0,
			caption= CONV,
			xlabel={{32, }},
			zlabel=\BeliefSize,
			fill=\ConvColor,
			height=16,
			width=4,
			depth=\BeliefDepth
			}
		};
	
	\pic[shift={ (0,0,0) }] at (conv0-east) 
		{Box={
			name=stride0,
			caption= ,
			zlabel=stride,
			fill=\PoolColor,
			opacity=0.5,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\draw [connection]  (input_target1-east)    -- node {\midarrow} (conv0-west);
	% \draw [connection]  (stride0-east)    -- node {\midarrow} (flat_target-west);
	
	\pic[shift={(2.5,-2.8,0)}] at (fc_ego-east) 
	% \pic[shift={(1.5,1.5,0)}] at (flat_target-east) 
		{Box={
			name=concat,
			caption=CONCAT,
			xlabel={{ , }},
			zlabel= ,
			fill=\UnpoolColor,
			height=36,
			width=4,
			depth=\BeliefDepth
			}
		};

	\draw [connection]  (fc_ego-east)    -- node {\midarrow} (concat-west);
	\draw [connection]  (stride0-east)    -- node {\midarrow} (concat-west);

	\pic[shift={(2,0,0)}] at (concat-east) 
		{Box={
			name=fc1,
			caption=FC,
			xlabel={{32, }},
			zlabel=\BeliefSize,
			fill=\FcColor,
			height=8,
			width=4,
			depth=\BeliefDepth
			}
		};
	

	\pic[shift={(1,0,0)}] at (fc1-east) 
		{Box={
			name=fc2,
			caption=FC,
			xlabel={{32, }},
			zlabel=\BeliefSize,
			fill=\FcReluColor,
			height=8,
			width=4,
			depth=\BeliefDepth
			}
		};

	\draw [connection]  (fc1-east)    -- node {\midarrow} (fc2-west);
	\draw [connection]  (concat-east)    -- node {\midarrow} (fc1-west);

	% \pic[shift={(2,0,0)}] at (fc2-east) 
	% 	{Box={
	% 		name=q_particle,
	% 		caption=$Q_{particle}$,
	% 		xlabel={{ , }},
	% 		ylabel= ,
	% 		zlabel=\BeliefSize,
	% 		fill=\SoftmaxColor,
	% 		opacity=0.8,
	% 		height=4,
	% 		width=1,
	% 		depth=\BeliefDepth
	% 		}
	% 	};
	
	% \draw [connection]  (fc2-east)    -- node {\midarrow} (q_particle-west);
	
	% \pic[shift={(1,0,0)}] at (q_particle-east) 
	% 	{Box={
	% 		name=estimator,
	% 		caption=$Estimator$,
	% 		xlabel={{ , }},
	% 		ylabel= ,
	% 		zlabel= ,
	% 		fill=\SoftmaxColor,
	% 		opacity=0.8,
	% 		height=4,
	% 		width=1,
	% 		depth=3
	% 		}
	% 	};

	% \draw [connection]  (q_particle-east)  -- node {\midarrow} (estimator-west);

	% \pic[shift={(2,0,0)}] at (estimator-east) 
	% 	{Box={
	% 		name=q,
	% 		caption=$Q$,
	% 		xlabel={{ , }},
	% 		ylabel= 2,
	% 		zlabel= ,
	% 		fill=\SoftmaxColor,
	% 		opacity=0.8,
	% 		height=2,
	% 		width=1,
	% 		depth=3
	% 		}
	% 	};

	% \draw [connection]  (estimator-east)    -- node {\midarrow} (q-west);
	}

	\newcommand{\makepointcloud}{
		\node[circle, draw=black, minimum size=2cm, label=below:{PF}] (pf) at (\pfx, \pfy) {}; 
		% \draw (\pfx, \pfy) circle (1);
		\draw[red, fill=red] (\pfx + 0.85 , \pfy + 0) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.1 , \pfy + 0.1) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.2 , \pfy + 0.3) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.4 , \pfy + 0.4) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.5 , \pfy + 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.2 , \pfy + 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.5 , \pfy + 0.2) circle (0.05);

		\draw[red, fill=red] (\pfx + 0.3 , \pfy + 0) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.1 , \pfy - 0.2) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.2 , \pfy - 0.3) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.4 , \pfy - 0.4) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.5 , \pfy - 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.2 , \pfy - 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx + 0.5 , \pfy - 0.2) circle (0.05);

		\draw[red, fill=red] (\pfx - 0.8 , \pfy + 0) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.1 , \pfy + 0.4) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.2 , \pfy + 0.3) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.4 , \pfy + 0.4) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.5 , \pfy + 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.2 , \pfy + 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.5 , \pfy + 0.2) circle (0.05);

		\draw[red, fill=red] (\pfx - 0.2 , \pfy + 0) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.1 , \pfy - 0.8) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.2 , \pfy - 0.3) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.4 , \pfy - 0.4) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.5 , \pfy - 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.2 , \pfy - 0.7) circle (0.05);
		\draw[red, fill=red] (\pfx - 0.5 , \pfy - 0.2) circle (0.05);
	}


	\beginpgfgraphicnamed{qpf}
	\begin{tikzpicture}
		\node[](obs) at (-5.5,0) {\Large o};

		\node (intent_state) at (-3, -5) {Intent from particle};

		\def\pfx{-3};
		\def\pfy{0};
		\makepointcloud;

		\def\BeliefSize{Belief};
		\basenet{16};
		\pic[shift={(2,0,0)}] at (fc2-east) 
		{Box={
			name=q_particle,
			caption=$Q_{particle}$,
			xlabel={{ , }},
			ylabel= ,
			zlabel=\BeliefSize,
			fill=\SoftmaxColor,
			opacity=0.8,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\draw [connection]  (fc2-east)    -- node {\midarrow} (q_particle-west);

		\pic[shift={(1,0,0)}] at (q_particle-east) 
		{Box={
			name=estimator,
			caption=$Estimator$,
			xlabel={{ , }},
			ylabel= ,
			zlabel= ,
			fill=\SoftmaxColor,
			opacity=0.8,
			height=4,
			width=1,
			depth=3
			}
		};
		\draw [connection]  (q_particle-east)  -- node {\midarrow} (estimator-west);
		\pic[shift={(2,0,0)}] at (estimator-east) 
			{Box={
				name=q,
				caption=$Q$,
				xlabel={{ , }},
				ylabel= 2,
				zlabel= 3,
				fill=\SoftmaxColor,
				opacity=0.8,
				height=2,
				width=1,
				depth=3
				}
			};
		\draw [connection]  (estimator-east)    -- node {\midarrow} (q-west);
		
		\draw [connection]  (obs)  -- node {\midarrow} (pf);
		\draw [connection]  (pf)  -- node {\midarrow} (input_ego-west);
		% \draw [connection]  (pf)  -- node {\midarrow} (input_target0-west);
		\draw [connection]  (pf)  -- node {\midarrow} (input_target1-west);
		% \draw [connection]  (pf)  -- node {\midarrow} (input_target2-west);
		% \draw [connection]  (pf)  -- node {\midarrow} (input_target3-west);

	\end{tikzpicture}\\
	\endpgfgraphicnamed

	\beginpgfgraphicnamed{qmdp}
	\begin{tikzpicture}
		\node[](obs_eq) at (-2.5,2) {$o = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop}, \{\hat{p}^{j}_\mathrm{int}, \hat{v}^j\}_{j=1}^N).$};
		\node[](obs) at (-5.5,0) {\Large o};
		\node (ego_state) at (0.1, 1) {$\hat{s}_e = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop})$};

		\node (target_state) at (-2.9, -3.5) {$\hat{s}_j = \{p^{j}_\mathrm{int}, v^j, i^j\}_{j=1}^N$};
		\node (intent_state) at (-3, -4) {Intent from particle};

		\node (q_value) at (12, -6) {\Large $Q = \frac{1}{M} \sum_{m=1}^M Q_{particle}$ eq.$(16)$};


		\def\pfx{-3}
		\def\pfy{0}
		\makepointcloud

		\def\BeliefSize{}
		\basenet{2};
		\pic[shift={(2,0,0)}] at (fc2-east) 
		{Box={
			name=q_particle,
			caption=$Q_{particle}$,
			xlabel={{2, }},
			ylabel= ,
			zlabel=\BeliefSize,
			fill=\SoftmaxColor,
			opacity=0.8,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\draw [connection]  (fc2-east)    -- node {\midarrow} (q_particle-west);

		\node (space) at (15,0) {};		
		\draw [connection]  (obs)  -- node {\midarrow} (pf);
		\draw [connection]  (pf)  -- node {\midarrow} (input_ego-west);
		\draw [connection]  (pf)  -- node {\midarrow} (input_target1-west);

	\end{tikzpicture}\\
	\endpgfgraphicnamed

	\beginpgfgraphicnamed{qie}
	\begin{tikzpicture}
		\node[](obs_eq) at (-2.5,2) {$o = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop}, \{\hat{p}^{j}_\mathrm{int}, \hat{v}^j\}_{j=1}^N).$};
		\node[](obs) at (-5.5,0) {\Large o};
		\node (ego_state) at (-0.7, 0.8) {$\hat{s}_e = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop})$};

		% \node (target_state) at (-2.9, -7) {$\hat{s}_j = \{p^{j}_\mathrm{int}, v^j, i^j\}_{j=1}^N$};
		% \node (intent_state) at (-3, -7.5) {Intent from eq.$(20)$};

		\node (target_state) at (-0.7, -2.5) {$\hat{s}_j = \{p^{j}_\mathrm{int}, v^j\}_{j=1}^N$};
		\node (intent_state) at (-1, -5.2) {$\hat{i}^j (20)$};

		\def\pfx{-3}
		\def\pfy{-4.8}
		\makepointcloud

		\def\BeliefSize{}
		\basenet{2};
		\pic[shift={(2,0,0)}] at (fc2-east) 
		{Box={
			name=q_particle,
			caption=$Q$,
			xlabel={{2, }},
			ylabel= ,
			zlabel=\BeliefSize,
			fill=\SoftmaxColor,
			opacity=0.8,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\draw [connection]  (fc2-east)    -- node {\midarrow} (q_particle-west);

		\node (space) at (15,0) {};		
		\draw [connection]  (obs)  -- node {\midarrow} (pf);

		\draw [connection]  (obs)  -- node {\midarrow} (input_ego-west);
		\draw [connection]  (obs)  -- node {\midarrow} (input_target1-west);
		\draw [connection]  (pf)  -- node {\midarrow} (input_target1-west);

	\end{tikzpicture}\\
	\endpgfgraphicnamed

	\beginpgfgraphicnamed{qid}
	\begin{tikzpicture}
		\node[](obs_eq) at (-2.5,2) {$o = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop}, \{\hat{p}^{j}_\mathrm{int}, \hat{v}^j\}_{j=1}^N).$};
		\node[](obs) at (-5.5,0) {\Large o};
		\node (ego_state) at (-0.7, 0.8) {$\hat{s}_e = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop})$};

		% \node (target_state) at (-2.9, -7) {$\hat{s}_j = \{p^{j}_\mathrm{int}, v^j, i^j\}_{j=1}^N$};
		% \node (intent_state) at (-3, -7.5) {Intent from eq.$(20)$};

		\node (target_state) at (-0.7, -2.5) {$\hat{s}_j = \{p^{j}_\mathrm{int}, v^j\}_{j=1}^N$};
		\node (intent_state) at (-1, -5.2) {$\hat{i}^j (19)$};

		\def\pfx{-3}
		\def\pfy{-4.8}
		\makepointcloud

		\def\BeliefSize{}
		\basenet{2};
		\pic[shift={(2,0,0)}] at (fc2-east) 
		{Box={
			name=q_particle,
			caption=$Q$,
			xlabel={{2, }},
			ylabel= ,
			zlabel=\BeliefSize,
			fill=\SoftmaxColor,
			opacity=0.8,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\draw [connection]  (fc2-east)    -- node {\midarrow} (q_particle-west);
		\node (space) at (15,0) {};		
		\draw [connection]  (obs)  -- node {\midarrow} (pf);

		\draw [connection]  (obs)  -- node {\midarrow} (input_ego-west);
		\draw [connection]  (obs)  -- node {\midarrow} (input_target1-west);
		\draw [connection]  (pf)  -- node {\midarrow} (input_target1-west);

	\end{tikzpicture}\\
	\endpgfgraphicnamed

	\beginpgfgraphicnamed{fo}
	\begin{tikzpicture}
		\node[](state_eq) at (-2.5,2) {$s = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop}, \{p^{j}_\mathrm{int}, v^j, i^i\}_{j=1}^N).$};
		\node[](state) at (-5.5,0) {\Large s};
		\node (ego_state) at (-0.7, 0.8) {$s_e = (p^\mathrm{ego}_\mathrm{goal},p^\mathrm{ego}_\mathrm{int}, v^\mathrm{ego}, t_\mathrm{stop})$};

		% \node (target_state) at (-2.9, -7) {$\hat{s}_j = \{p^{j}_\mathrm{int}, v^j, i^j\}_{j=1}^N$};
		% \node (intent_state) at (-3, -7.5) {Intent from eq.$(20)$};

		\node (target_state) at (-0.7, -2.5) {$s_j = \{p^{j}_\mathrm{int}, v^j, i^j\}_{j=1}^N$};
		% \node (intent_state) at (-1, -5.2) {true ${i}^j$};

		% \def\pfx{-3}
		% \def\pfy{-4.8}
		% \makepointcloud

		\def\BeliefSize{}
		\basenet{2};
		\pic[shift={(2,0,0)}] at (fc2-east) 
		{Box={
			name=q_particle,
			caption=$Q$,
			xlabel={{2, }},
			ylabel= ,
			zlabel=\BeliefSize,
			fill=\SoftmaxColor,
			opacity=0.8,
			height=4,
			width=1,
			depth=\BeliefDepth
			}
		};
	
	\draw [connection]  (fc2-east)    -- node {\midarrow} (q_particle-west);
		\node (space) at (15,0) {};		
		% \draw [connection]  (obs)  -- node {\midarrow} (pf);

		\draw [connection]  (state)  -- node {\midarrow} (input_ego-west);
		\draw [connection]  (state)  -- node {\midarrow} (input_target1-west);
		% \draw [connection]  (pf)  -- node {\midarrow} (input_target1-west);

	\end{tikzpicture}\\
	\endpgfgraphicnamed

	\beginpgfgraphicnamed{belief}
	\begin{tikzpicture}
		\tikzstyle{connection}=[ultra thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
		\tikzstyle{copyconnection}=[ultra thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]
		
		\def\BeliefSize{Belief}
		\def\BeliefDepth{16}
		
		\pic[shift={(0,0,0)}] at (0,0,0) 
			{Box={
				name=input_ego,
				caption=Ego \\ input,
				xlabel={{ , }},
				ylabel=4,
				zlabel=\BeliefSize,
				fill=\InputColor,
				height=4,
				width=1,
				depth=\BeliefDepth
				}
			};
		
		\pic[shift={(2,0,0)}] at (input_ego-east) 
			{Box={
				name=fc_ego,
				caption= FC,
				xlabel={{32, }},
				zlabel=\BeliefSize,
				fill=\FcColor,
				height=8,
				width=4,
				depth=\BeliefDepth
				}
			};

		% \pic[shift={(1.5,0,0)}] at (fc_ego-east) 
		% 	{Box={
		% 		name=flat_ego,
		% 		caption= ,
		% 		xlabel={{ , }},
		% 		zlabel=\BeliefSize,
		% 		fill=\ConvColor,
		% 		height=13,
		% 		width=1,
		% 		depth=\BeliefDepth
		% 		}
		% 	};
		
		\draw [connection]  (input_ego-east)    -- node {\midarrow} (fc_ego-west);
		% \draw [connection]  (fc_ego-east)    -- node {\midarrow} (flat_ego-west);
		
		\pic[shift={(0,-3.6,0)}] at (input_ego-south) 
			{Box={
				name=input_target0,
				caption= ,
				xlabel={{ , }},
				ylabel=3,
				zlabel= ,
				fill=\InputColor,
				height=4,
				width=1,
				depth=\BeliefDepth
				}
			};
		\pic[shift={(-0.1,-0.4,0)}] at (input_target0-south) 
			{Box={
				name=input_target1,
				caption= ,
				xlabel={{ , }},
				ylabel=3,
				zlabel= ,
				fill=\InputColor,
				height=4,
				width=1,
				depth=\BeliefDepth
				}
			};

		\pic[shift={(-0.1,-0.4,0)}] at (input_target1-south) 
			{Box={
				name=input_target2,
				caption= ,
				xlabel={{ , }},
				ylabel=3,
				zlabel= ,
				fill=\InputColor,
				height=4,
				width=1,
				depth=\BeliefDepth
				}
			};

		\pic[shift={(-0.1,-0.4,0)}] at (input_target2-south) 
			{Box={
				name=input_target3,
				caption= Target\\input,
				xlabel={{ , }},
				ylabel=3,
				zlabel=\BeliefSize,
				fill=\InputColor,
				height=4,
				width=1,
				depth=\BeliefDepth
				}
			};
		
		\pic[shift={(1.9,-0,0)}] at (input_target1-east) 
			{Box={
				name=conv0,
				caption= CONV,
				xlabel={{32, }},
				zlabel=\BeliefSize,
				fill=\ConvColor,
				height=16,
				width=4,
				depth=\BeliefDepth
				}
			};
		
		\pic[shift={ (0,0,0) }] at (conv0-east) 
			{Box={
				name=stride0,
				caption= ,
				zlabel=stride,
				fill=\PoolColor,
				opacity=0.5,
				height=4,
				width=1,
				depth=\BeliefDepth
				}
			};

		% \pic[shift={(1.1,0,0)}] at (stride0-east) 
		% 	{Box={
		% 		name=flat_target,
		% 		caption= ,
		% 		xlabel={{ , }},
		% 		zlabel=\BeliefSize,
		% 		fill=\ConvColor,
		% 		height=26,
		% 		width=1,
		% 		depth=\BeliefDepth
		% 		}
		% 	};
		
		\draw [connection]  (input_target1-east)    -- node {\midarrow} (conv0-west);
		% \draw [connection]  (stride0-east)    -- node {\midarrow} (flat_target-west);
		
		\pic[shift={(2.5,-2.8,0)}] at (fc_ego-east) 
		% \pic[shift={(1.5,1.5,0)}] at (flat_target-east) 
			{Box={
				name=concat,
				caption=CONCAT,
				xlabel={{ , }},
				zlabel= ,
				fill=\UnpoolColor,
				height=36,
				width=4,
				depth=\BeliefDepth
				}
			};

		% \pic[shift={(2,0,0)}] at (fc_ego-east) 
		% 	{Box={
		% 		name=concat_ego,
		% 		caption= ,
		% 		xlabel={{ , }},
		% 		zlabel= ,
		% 		fill=\ConvColor,
		% 		height=16,
		% 		width=1,
		% 		depth=\BeliefDepth
		% 		}
		% 	};

		% \pic[shift={(-0.1,-3.2,0)}] at (concat_ego-south) 
		% 	{Box={
		% 		name=concat_target,
		% 		caption= ,
		% 		xlabel={{1, }},
		% 		zlabel=\BeliefSize,
		% 		fill=\ConvColor,
		% 		height=32,
		% 		width=1,
		% 		depth=\BeliefDepth
		% 		}
		% 	};
		
		% \draw [connection]  (flat_ego-east)    -- node {\midarrow} (concat-west);
		% \draw [connection]  (flat_target-east)    -- node {\midarrow} (concat-west);

		\draw [connection]  (fc_ego-east)    -- node {\midarrow} (concat-west);
		\draw [connection]  (stride0-east)    -- node {\midarrow} (concat-west);

		\pic[shift={(2,0,0)}] at (concat-east) 
			{Box={
				name=fc1,
				caption=FC,
				xlabel={{32, }},
				zlabel=\BeliefSize,
				fill=\FcColor,
				height=8,
				width=4,
				depth=\BeliefDepth
				}
			};
		

		\pic[shift={(1,0,0)}] at (fc1-east) 
			{Box={
				name=fc2,
				caption=FC,
				xlabel={{32, }},
				zlabel=\BeliefSize,
				fill=\FcReluColor,
				height=8,
				width=4,
				depth=\BeliefDepth
				}
			};

		\draw [connection]  (fc1-east)    -- node {\midarrow} (fc2-west);
		\draw [connection]  (concat-east)    -- node {\midarrow} (fc1-west);
	
		\pic[shift={(2,0,0)}] at (fc2-east) 
			{Box={
				name=q_particle,
				caption=$Q_{particle}$,
				xlabel={{ , }},
				ylabel= ,
				zlabel=\BeliefSize,
				fill=\SoftmaxColor,
				opacity=0.8,
				height=4,
				width=1,
				depth=\BeliefDepth
				}
			};
		
		\draw [connection]  (fc2-east)    -- node {\midarrow} (q_particle-west);
		
		\pic[shift={(1,0,0)}] at (q_particle-east) 
			{Box={
				name=estimator,
				caption=$Estimator$,
				xlabel={{ , }},
				ylabel= ,
				zlabel= ,
				fill=\SoftmaxColor,
				opacity=0.8,
				height=4,
				width=1,
				depth=3
				}
			};

		\draw [connection]  (q_particle-east)    -- node {\midarrow} (estimator-west);

		\pic[shift={(2,0,0)}] at (estimator-east) 
			{Box={
				name=q,
				caption=$Q$,
				xlabel={{ , }},
				ylabel= 2,
				zlabel= ,
				fill=\SoftmaxColor,
				opacity=0.8,
				height=2,
				width=1,
				depth=3
				}
			};

		\draw [connection]  (estimator-east)    -- node {\midarrow} (q-west);

	\end{tikzpicture}\\
	\endpgfgraphicnamed

\end{document}